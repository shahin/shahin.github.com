<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Malthusian Flytrap]]></title>
  <link href="http://shahin.github.com/atom.xml" rel="self"/>
  <link href="http://shahin.github.com/"/>
  <updated>2013-03-10T21:05:26-07:00</updated>
  <id>http://shahin.github.com/</id>
  <author>
    <name><![CDATA[Shahin Saneinejad]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Weather Forecasts in PostGIS]]></title>
    <link href="http://shahin.github.com/blog/2013/03/10/weather-forecasts-in-postgis/"/>
    <updated>2013-03-10T12:56:00-07:00</updated>
    <id>http://shahin.github.com/blog/2013/03/10/weather-forecasts-in-postgis</id>
    <content type="html"><![CDATA[<p>Weather forecast data is fun to analyze, but the huge array of specialized GIS data sources and representations can make it hard to get started. Here, we&#8217;ll walk through a simple way to get NOAA forecast data stored locally in a PostGIS database.</p>

<h2>Install PostGIS</h2>

<p>PostGIS is a widely-used spatial database built on the popular PostgreSQL database. On a Mac, <a href="http://postgresapp.com/">Postgres.app</a> makes it dead simple to install PostgreSQL and the PostGIS extension in one fell swoop.</p>

<h2>Download Forecast Data</h2>

<p>NOAA makes forecast data available through the <a href="http://www.nws.noaa.gov/ndfd/">National Digital Forecast Database (NDFD)</a>. They provide <a href="http://graphical.weather.gov/xml/rest.php">a RESTful web service</a> for requesting XML forecasts on small geographic regions, but we want nationwide data. Current nationwide forecasts are available in GRIB2 format on the <a href="http://www.nws.noaa.gov/ndfd/anonymous_ftp.htm">NDFD&#8217;s FTP servers</a>.</p>

<p>Download the probability-of-precipitation field for the <a href="ftp://tgftp.nws.noaa.gov/SL.us008001/ST.opnl/DF.gr2/DC.ndfd/AR.conus/VP.001-003/">current forecast</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget ftp://tgftp.nws.noaa.gov/SL.us008001/ST.opnl/DF.gr2/DC.ndfd/AR.conus/VP.001-003/ds.pop12.bin
</span></code></pre></td></tr></table></div></figure>


<p>The remaining steps below should work equally well with other forecast data fields listed in the same folder.</p>

<h2>Reformat Data as CSV</h2>

<p>GRIB2 is a compressed data format that most non-meteorological tools (including Postgres) don&#8217;t understand. We&#8217;ll take the path of least resistance by first converting it to a simple CSV using the <a href="http://www.cpc.ncep.noaa.gov/products/wesley/wgrib2/">wgrib2</a> tool. For the MacPorts-averse, it can be compiled locally from source with default options:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tar xzf wgrib2.tgz.v1.9.7a
</span><span class='line'><span class="nb">cd </span>grib2
</span><span class='line'>make
</span></code></pre></td></tr></table></div></figure>


<p>Conversion from GRIB2 to CSV is now a one-liner:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wgrib2 ds.pop12.bin -csv pop12.csv
</span></code></pre></td></tr></table></div></figure>


<h2>Import into Postgres</h2>

<p>First, create a new database to store our forecasts and enable the PostGIS extension:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">weather</span><span class="p">;</span>
</span><span class='line'><span class="err">\</span><span class="k">connect</span> <span class="n">weather</span><span class="p">;</span>
</span><span class='line'><span class="k">CREATE</span> <span class="n">EXTENSION</span> <span class="n">postgis</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need to create table to hold our downloaded forecast data and a new spatial attribute. PostGIS provides both Geometry and Geography data types. The Geometry type offers better performance and advanced features at the expense of accuracy on large scales. Since our data is nationwide, we&#8217;ll opt for <a href="http://postgis.net/docs/manual-2.0/using_postgis_dbmanagement.html#PostGIS_Geography">the Geography type</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">create</span> <span class="k">table</span> <span class="n">pop</span><span class="p">(</span>
</span><span class='line'>  <span class="n">id</span> <span class="nb">serial</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>  <span class="n">start_forecast_utc</span> <span class="k">timestamp</span><span class="p">,</span>
</span><span class='line'>  <span class="n">end_forecast_utc</span> <span class="k">timestamp</span><span class="p">,</span>
</span><span class='line'>  <span class="n">field</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
</span><span class='line'>  <span class="n">field_level</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
</span><span class='line'>  <span class="n">longitude</span> <span class="nb">real</span><span class="p">,</span>
</span><span class='line'>  <span class="n">latitude</span> <span class="nb">real</span><span class="p">,</span>
</span><span class='line'>  <span class="n">grid_value</span> <span class="nb">real</span><span class="p">,</span>
</span><span class='line'>  <span class="n">long_lat</span> <span class="n">geography</span><span class="p">(</span><span class="n">point</span><span class="p">,</span><span class="mi">4326</span><span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, import the CSV and populate the spatial attribute as a function of longitude and latitude coordinates:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">copy</span> <span class="n">pop</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">start_forecast_utc</span><span class="p">,</span>
</span><span class='line'>  <span class="n">end_forecast_utc</span><span class="p">,</span>
</span><span class='line'>  <span class="n">field</span><span class="p">,</span>
</span><span class='line'>  <span class="n">field_level</span><span class="p">,</span>
</span><span class='line'>  <span class="n">longitude</span><span class="p">,</span>
</span><span class='line'>  <span class="n">latitude</span><span class="p">,</span>
</span><span class='line'>  <span class="n">grid_value</span>
</span><span class='line'><span class="p">)</span> <span class="k">from</span> <span class="s1">&#39;pop12.csv&#39;</span> <span class="k">with</span> <span class="p">(</span><span class="n">format</span> <span class="n">csv</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">update</span> <span class="n">pop</span>
</span><span class='line'>  <span class="k">set</span> <span class="n">long_lat</span> <span class="o">=</span> <span class="n">ST_GeographyFromText</span><span class="p">(</span><span class="s1">&#39;SRID=4326;POINT(&#39;</span> <span class="o">||</span> <span class="n">longitude</span> <span class="o">||</span> <span class="s1">&#39; &#39;</span> <span class="o">||</span> <span class="n">latitude</span> <span class="o">||</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Run a Test Query</h2>

<p>Now we can answer questions like &#8220;Where will it rain in between San Francisco and LA?&#8221;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span>
</span><span class='line'>  <span class="n">start_forecast_utc</span><span class="p">,</span>
</span><span class='line'>  <span class="n">latitude</span><span class="p">,</span>
</span><span class='line'>  <span class="n">longitude</span><span class="p">,</span>
</span><span class='line'>  <span class="n">grid_value</span> <span class="k">as</span> <span class="n">prob_precip</span>
</span><span class='line'><span class="k">from</span> <span class="n">pop</span> <span class="k">where</span>
</span><span class='line'>  <span class="n">ST_Distance</span> <span class="p">(</span><span class="s1">&#39;LINESTRING(-122.420654 37.781569, -118.168945 33.988918)&#39;</span><span class="p">::</span><span class="n">geography</span><span class="p">,</span> <span class="n">long_lat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8000</span> <span class="k">and</span>
</span><span class='line'>  <span class="n">grid_value</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Take a second to bask in success: NOAA forecast data is ready for spatial analysis in PostgreSQL.</p>
]]></content>
  </entry>
  
</feed>
